name: Build and Release

# Trigger on pushes to master branch
on:
  push:
    branches:
      - master

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      tag_name: ${{ steps.get_version.outputs.tag_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get version from package.json
        id: get_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=v$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

  build-windows:
    needs: prepare-release
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Build Windows installer
        env:
          KOLBO_ENV: production
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run build:prod:win

      - name: Fix filename format in latest.yml
        shell: bash
        run: |
          sed -i 's/Kolbo-Studio/Kolbo.Studio/g' dist/latest.yml
          cat dist/latest.yml

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            dist/Kolbo Studio-Setup-${{ needs.prepare-release.outputs.version }}.exe
            dist/Kolbo Studio-Setup-${{ needs.prepare-release.outputs.version }}.exe.blockmap
            dist/latest.yml

  build-macos:
    needs: prepare-release
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Generate Mac icon with rounded corners
        run: node scripts/generate-icons.js

      - name: Build macOS DMG
        env:
          KOLBO_ENV: production
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run build:prod:mac

      - name: Fix filename format in latest-mac.yml
        run: |
          sed -i '' 's/Kolbo-Studio/Kolbo.Studio/g' dist/latest-mac.yml
          cat dist/latest-mac.yml

      - name: Create backward compatible DMG (universal)
        run: |
          cp "dist/Kolbo Studio-${{ needs.prepare-release.outputs.version }}-arm64.dmg" "dist/Kolbo.Studio-${{ needs.prepare-release.outputs.version }}.dmg"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: |
            dist/Kolbo Studio-${{ needs.prepare-release.outputs.version }}-arm64.dmg
            dist/Kolbo Studio-${{ needs.prepare-release.outputs.version }}-x64.dmg
            dist/Kolbo.Studio-${{ needs.prepare-release.outputs.version }}.dmg
            dist/latest-mac.yml

  create-release:
    needs: [prepare-release, build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-artifacts
          path: ./dist-windows

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-artifacts
          path: ./dist-macos

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag_name }}
          name: Kolbo Studio v${{ needs.prepare-release.outputs.version }}
          body: |
            ## Kolbo Studio v${{ needs.prepare-release.outputs.version }}

            ### Downloads
            - **Windows**: Kolbo.Studio-Setup-${{ needs.prepare-release.outputs.version }}.exe
            - **macOS (Apple Silicon)**: Kolbo.Studio-${{ needs.prepare-release.outputs.version }}-arm64.dmg
            - **macOS (Intel)**: Kolbo.Studio-${{ needs.prepare-release.outputs.version }}-x64.dmg
            - **macOS (Universal)**: Kolbo.Studio-${{ needs.prepare-release.outputs.version }}.dmg

            ### Installation
            **Windows**: Download the .exe installer and run it. Follow the setup wizard.

            **macOS**: Download the appropriate .dmg file for your Mac:
            - Apple Silicon (M1/M2/M3): Download the arm64 version
            - Intel Mac: Download the x64 version
            - Not sure? Download the Universal version

            Open the DMG and drag Kolbo Studio to Applications.

            ### Auto-Update
            Existing users will be notified automatically within the app. Click "Download Update" to get the latest version.

            ---
            ðŸš€ **Auto-generated release from master branch**
          draft: false
          prerelease: false
          files: |
            dist-windows/*
            dist-macos/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
