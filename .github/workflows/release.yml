name: Build and Release

# Trigger on pushes to master branch
on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      tag_name: ${{ steps.get_version.outputs.tag_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get version from package.json
        id: get_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=v$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

  build-windows:
    needs: prepare-release
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Build Windows installer
        env:
          KOLBO_ENV: production
        run: |
          # Use --publish never to prevent electron-builder from publishing to GitHub
          # The workflow handles uploading to the release instead
          node build-env.js
          npx electron-builder --win --publish never

      - name: Fix filename format in latest.yml
        shell: bash
        run: |
          sed -i 's/Kolbo-Studio/Kolbo.Studio/g' dist/latest.yml
          cat dist/latest.yml

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            dist/Kolbo Studio-Setup-${{ needs.prepare-release.outputs.version }}.exe
            dist/Kolbo Studio-Setup-${{ needs.prepare-release.outputs.version }}.exe.blockmap
            dist/latest.yml

  build-macos:
    needs: prepare-release
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Generate Mac icon with rounded corners
        run: node scripts/generate-icons.js

      - name: Build macOS DMG
        env:
          KOLBO_ENV: production
        run: |
          echo "=== Starting Mac build ==="
          # Use --publish never to prevent electron-builder from publishing to GitHub
          # The workflow handles uploading to the release instead
          node build-env.js
          npx electron-builder --mac --publish never
          BUILD_EXIT_CODE=$?
          echo "=== Build exit code: $BUILD_EXIT_CODE ==="
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "‚ùå Mac build failed with exit code $BUILD_EXIT_CODE"
            exit $BUILD_EXIT_CODE
          fi
          echo "‚úÖ Mac build completed successfully"

      - name: Fix filename format in latest-mac.yml
        shell: bash
        run: |
          echo "=== Original latest-mac.yml ==="
          cat dist/latest-mac.yml
          # Replace dashes in product name with spaces: Kolbo-Studio -> Kolbo Studio
          # KEEP the arch suffixes (arm64, x64) - they're needed for v1.0.0 compatibility
          # macOS sed requires -i '' (empty backup extension)
          sed -i '' 's/Kolbo-Studio/Kolbo Studio/g' dist/latest-mac.yml
          # Remove -mac suffix from ZIP filenames (keep arm64/x64)
          sed -i '' 's/-arm64-mac\.zip/-arm64.zip/g' dist/latest-mac.yml
          sed -i '' 's/-x64-mac\.zip/-x64.zip/g' dist/latest-mac.yml
          echo "=== Fixed latest-mac.yml ==="
          cat dist/latest-mac.yml

      - name: Debug - List Mac dist files
        run: |
          echo "=== Contents of dist directory ==="
          ls -lah dist/ || echo "dist directory not found"
          echo "=== Looking for DMG files ==="
          find dist/ -name "*.dmg" -o -name "*.zip" -o -name "*.yml" || echo "No matching files found"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: |
            dist/Kolbo Studio-${{ needs.prepare-release.outputs.version }}-arm64.dmg
            dist/Kolbo Studio-${{ needs.prepare-release.outputs.version }}-x64.dmg
            dist/Kolbo Studio-${{ needs.prepare-release.outputs.version }}-arm64-mac.zip
            dist/Kolbo Studio-${{ needs.prepare-release.outputs.version }}-x64-mac.zip
            dist/latest-mac.yml

  create-release:
    needs: [prepare-release, build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-artifacts
          path: ./dist-windows

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-artifacts
          path: ./dist-macos

      # ‚ö†Ô∏è CRITICAL: DO NOT RENAME FILES! ‚ö†Ô∏è
      # GitHub automatically converts spaces to dots in uploaded filenames:
      # "Kolbo Studio-Setup-1.0.2.exe" becomes "Kolbo.Studio-Setup-1.0.2.exe"
      #
      # The app code (main.js) expects filenames with DOTS to match GitHub's behavior.
      # If you rename files here (e.g., spaces->dashes), it will break auto-updates
      # for ALL existing users because their app expects the dot notation.
      #
      # The latest.yml file created by electron-builder will have the original
      # filename with spaces, but when users download from GitHub, spaces become dots.
      # This is expected and correct behavior - DO NOT "fix" it!

      - name: Validate filenames before consolidation
        run: |
          echo "=== Validating Windows artifacts ==="
          ls ./dist-windows/
          if ! ls ./dist-windows/ | grep -q "Kolbo Studio-Setup"; then
            echo "‚ùå ERROR: Windows installer not found with expected 'Kolbo Studio-Setup' name"
            exit 1
          fi
          if ! ls ./dist-windows/latest.yml >/dev/null 2>&1; then
            echo "‚ùå ERROR: latest.yml not found in Windows artifacts"
            exit 1
          fi

          echo "=== Validating Mac artifacts ==="
          ls ./dist-macos/
          if ! ls ./dist-macos/ | grep -q "Kolbo Studio-.*-arm64\.dmg"; then
            echo "‚ùå ERROR: Mac arm64 DMG not found"
            exit 1
          fi
          if ! ls ./dist-macos/ | grep -q "Kolbo Studio-.*-x64\.dmg"; then
            echo "‚ùå ERROR: Mac x64 DMG not found"
            exit 1
          fi
          if ! ls ./dist-macos/ | grep -q "Kolbo Studio-.*-arm64-mac\.zip"; then
            echo "‚ùå ERROR: Mac arm64 ZIP not found"
            exit 1
          fi
          if ! ls ./dist-macos/ | grep -q "Kolbo Studio-.*-x64-mac\.zip"; then
            echo "‚ùå ERROR: Mac x64 ZIP not found"
            exit 1
          fi
          if ! ls ./dist-macos/latest-mac.yml >/dev/null 2>&1; then
            echo "‚ùå ERROR: latest-mac.yml not found in Mac artifacts"
            exit 1
          fi

          echo "‚úÖ All filenames validated successfully"

      # Mac files are created with -mac suffix for ZIPs (e.g., arm64-mac.zip, x64-mac.zip).
      # We rename to remove -mac suffix to match what the app expects.
      # Keep arch suffixes (arm64, x64) for v1.0.0 compatibility.
      - name: Rename Mac ZIP files to remove -mac suffix
        run: |
          echo "=== Renaming Mac ZIP files ==="
          cd ./dist-macos
          # Rename arm64 ZIP: remove -mac suffix
          if [ -f "Kolbo Studio-${{ needs.prepare-release.outputs.version }}-arm64-mac.zip" ]; then
            mv "Kolbo Studio-${{ needs.prepare-release.outputs.version }}-arm64-mac.zip" "Kolbo Studio-${{ needs.prepare-release.outputs.version }}-arm64.zip"
            echo "‚úÖ Renamed arm64 ZIP file"
          fi
          # Rename x64 ZIP: remove -mac suffix
          if [ -f "Kolbo Studio-${{ needs.prepare-release.outputs.version }}-x64-mac.zip" ]; then
            mv "Kolbo Studio-${{ needs.prepare-release.outputs.version }}-x64-mac.zip" "Kolbo Studio-${{ needs.prepare-release.outputs.version }}-x64.zip"
            echo "‚úÖ Renamed x64 ZIP file"
          fi
          # DMG files don't need renaming - they're already correct
          echo "=== Mac files after rename ==="
          ls -lah
          cd ..

      - name: Consolidate all artifacts into single directory
        run: |
          mkdir -p ./release-artifacts
          cp -v ./dist-windows/* ./release-artifacts/
          cp -v ./dist-macos/* ./release-artifacts/
          echo "=== Final artifacts to upload ==="
          ls -lah ./release-artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag_name }}
          name: Kolbo Studio v${{ needs.prepare-release.outputs.version }}
          body: |
            ## Kolbo Studio v${{ needs.prepare-release.outputs.version }}

            ### Downloads
            - **Windows**: Kolbo.Studio-Setup-${{ needs.prepare-release.outputs.version }}.exe
            - **macOS (Universal)**: Kolbo.Studio-${{ needs.prepare-release.outputs.version }}.dmg (works on both Intel and Apple Silicon)

            ### Installation
            **Windows**: Download the .exe installer and run it. Follow the setup wizard.

            **macOS**: Download the .dmg file. It's a universal binary that works on both Intel and Apple Silicon Macs. Open the DMG and drag Kolbo Studio to Applications.

            ### Auto-Update
            Existing users will be notified automatically within the app. Click "Download Update" to get the latest version.

            ---
            üöÄ **Auto-generated release from master branch**
          draft: false
          prerelease: false
          files: release-artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
